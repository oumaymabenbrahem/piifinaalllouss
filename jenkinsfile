pipeline {
    agent {
        docker {
            image 'node:18'
            args '-u root --network=host'
        }
    }
    environment {
        // Configuration SonarQube
        SONAR_SCANNER_HOME = tool 'scanner'  
        SONAR_PROJECT_KEY = 'piapp'
        SONAR_PROJECT_NAME = 'PI Application'
        SONAR_SOURCES = 'src'
    }
    stages {
        /* Installation des dépendances */
        stage('Install Dependencies') {
            parallel {
                stage('Client') {
                    steps {
                        dir('client') {
                            sh 'npm ci'
                        }
                    }
                }
                stage('Server') {
                    steps {
                        dir('server') {
                            sh 'npm ci'
                        }
                    }
                }
            }
        }

        /* Tests */
        stage('Run Tests') {
            parallel {
                stage('Client Tests') {
                    steps {
                        dir('client') {
                            script {
                                sh 'npm test || echo "Aucun test client configuré"'
                            }
                        }
                    }
                }
                stage('Server Tests') {
                    steps {
                        dir('server') {
                            script {
                                sh 'npm test || echo "Aucun test serveur configuré"'
                            }
                        }
                    }
                }
            }
        }

        /* Analyse SonarQube (optionnelle si configurée) */
        stage('SonarQube Analysis') {
            when {
                allOf {
                    environment name: 'SONAR_HOST_URL', value: ''
                    environment name: 'SONAR_AUTH_TOKEN', value: ''
                }
            }
            steps {
                withSonarQubeEnv('SonarQube') {
                    script {
                        try {
                            sh """
                                ${SONAR_SCANNER_HOME}/bin/sonar-scanner \
                                -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
                                -Dsonar.projectName="${SONAR_PROJECT_NAME}" \
                                -Dsonar.sources=${SONAR_SOURCES} \
                                -Dsonar.host.url=${SONAR_HOST_URL} \
                                -Dsonar.login=${SONAR_AUTH_TOKEN} \
                                -Dsonar.javascript.node=18 \
                                -Dsonar.exclusions=**/node_modules/**,**/dist/**
                            """
                        } catch (err) {
                            echo "Erreur SonarQube: ${err}"
                            // Ne pas faire échouer le pipeline pour SonarQube
                        }
                    }
                }
            }
        }

        /* Build Client */
        stage('Build Client') {
            steps {
                dir('client') {
                    sh 'npm run build'
                    archiveArtifacts artifacts: 'dist/**/*', fingerprint: true
                }
            }
        }
    }
    post {
        always {
            echo 'Nettoyage terminé'
        }
        success {
            echo '✅ Pipeline réussie'
        }
        failure {
            echo '❌ Pipeline échouée'
        }
    }
}
